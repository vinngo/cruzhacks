---
phase: 03-guidance-annotations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/workspace/ChatPanel.tsx
  - app/workspace/page.tsx
  - app/api/chat/route.ts
  - lib/ai/prompt.ts
  - lib/types/annotations.ts
autonomous: true

must_haves:
  truths:
    - "User can collapse chat sidebar to maximize canvas space"
    - "User can expand chat sidebar to view AI conversation"
    - "AI proposes specific canvas annotations in structured format"
    - "AI proposes both question annotations and hint annotations"
    - "Annotation proposals include text, type, and suggested position"
  artifacts:
    - path: "components/workspace/ChatPanel.tsx"
      provides: "Collapsible state with smooth animation"
      min_lines: 220
      contains: "isCollapsed|setIsCollapsed"
    - path: "app/workspace/page.tsx"
      provides: "Layout adapts to collapsed/expanded chat state"
      min_lines: 50
      contains: "transition-all"
    - path: "app/api/chat/route.ts"
      provides: "Structured annotation proposals via AI tool calling"
      exports: ["POST"]
      contains: "tools.*proposeAnnotation"
    - path: "lib/types/annotations.ts"
      provides: "Annotation type definitions"
      exports: ["ProposedAnnotation", "AnnotationType"]
  key_links:
    - from: "components/workspace/ChatPanel.tsx"
      to: "app/workspace/page.tsx"
      via: "isCollapsed state prop or context"
      pattern: "isCollapsed"
    - from: "app/api/chat/route.ts"
      to: "AI SDK tool calling"
      via: "tools configuration with proposeAnnotation"
      pattern: "tools.*proposeAnnotation"
---

<objective>
Implement collapsible chat sidebar and AI structured annotation proposals.

Purpose: Enable users to maximize canvas space by collapsing chat, and set up AI system to propose canvas annotations (questions and hints) in structured format for rendering. Establishes foundation for Phase 3's core value: AI guides via interactive canvas annotations.

Output: Collapsible chat sidebar with smooth transitions, AI generating structured annotation proposals (type, text, position), type definitions for annotation system.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-problem-input---ai-integration/02-01-SUMMARY.md

# Existing files
@components/workspace/ChatPanel.tsx
@app/workspace/page.tsx
@app/api/chat/route.ts
@lib/ai/prompt.ts
</context>

<tasks>

<task type="auto">
  <name>Add collapsible sidebar to ChatPanel</name>
  <files>components/workspace/ChatPanel.tsx, app/workspace/page.tsx</files>
  <action>
**ChatPanel.tsx changes:**
- Add isCollapsed state: `const [isCollapsed, setIsCollapsed] = useState(false)`
- Add toggle button in header (next to "AI Tutor" title):
  - Icon: ChevronRightIcon when expanded, ChevronLeftIcon when collapsed
  - Position: Absolute right side of header
  - Click handler: toggles isCollapsed state
- Apply conditional width classes:
  - Expanded: `w-80` (320px)
  - Collapsed: `w-12` (48px, just enough for toggle button)
- Add smooth transition: `transition-all duration-300 ease-in-out`
- Hide content when collapsed (messages, input form): `{!isCollapsed && (<>...</>)}`
- Keep header visible always (for toggle button)
- Collapsed state shows only vertical "AI Tutor" text or icon

**workspace/page.tsx changes:**
- Accept ChatPanel's width changes dynamically
- Canvas should expand when chat collapses: use `flex-1` on CanvasPanel
- Layout: `flex` with ChatPanel on right, CanvasPanel flex-grows left
- No hardcoded widths - let ChatPanel control its own width

**UX details:**
- Smooth animation (300ms matches project's established transition duration from STATE.md)
- Toggle button always visible (user can expand even when collapsed)
- Collapsed shows minimal UI: just toggle button + "AI" text vertically
- Keyboard accessible: toggle button focusable with Enter/Space handlers

**Implementation:**
```tsx
// ChatPanel.tsx
const [isCollapsed, setIsCollapsed] = useState(false);

return (
  <div className={cn(
    "flex flex-col bg-white border-l border-gray-200 transition-all duration-300 ease-in-out",
    isCollapsed ? "w-12" : "w-80"
  )}>
    <div className="border-b border-gray-200 px-4 py-3 flex items-center justify-between">
      {!isCollapsed && <h2 className="text-lg font-semibold">AI Tutor</h2>}
      <button onClick={() => setIsCollapsed(!isCollapsed)} aria-label={isCollapsed ? "Expand chat" : "Collapse chat"}>
        {isCollapsed ? <ChevronLeftIcon /> : <ChevronRightIcon />}
      </button>
    </div>
    {!isCollapsed && (
      <>{/* messages and input */}</>
    )}
    {isCollapsed && (
      <div className="flex-1 flex items-center justify-center">
        <span className="text-sm text-gray-500 rotate-90 whitespace-nowrap">AI</span>
      </div>
    )}
  </div>
);
```

Use `lucide-react` icons (already in package.json): ChevronLeftIcon, ChevronRightIcon.
  </action>
  <verify>
    Click toggle button → chat collapses to ~48px width with smooth animation
    Canvas expands to fill space (flexbox works)
    Click again → chat expands to 320px
    Collapsed state shows "AI" text vertically
    Toggle button accessible via keyboard (Tab + Enter)
    No layout shift or jank during transition
    Build passes: npm run build
  </verify>
  <done>Chat sidebar collapses/expands smoothly, canvas adapts to available space, toggle always accessible</done>
</task>

<task type="auto">
  <name>Implement AI annotation proposal system with structured output</name>
  <files>lib/types/annotations.ts, app/api/chat/route.ts, lib/ai/prompt.ts</files>
  <action>
**Create lib/types/annotations.ts:**
Define TypeScript types for annotation system:

```typescript
export type AnnotationType = "question" | "hint";

export interface ProposedAnnotation {
  id: string;
  type: AnnotationType;
  text: string;
  position?: {
    x: number;
    y: number;
  };
  color?: string;
}

export interface AnnotationProposal {
  annotations: ProposedAnnotation[];
}
```

**Update app/api/chat/route.ts:**
Add AI SDK tool calling for structured annotation proposals:

```typescript
import { streamText, tool } from 'ai';
import { z } from 'zod';

// Define annotation tool
const proposeAnnotationTool = tool({
  name: 'proposeAnnotation',
  description: 'Propose a canvas annotation (question or hint) to guide the student. Use this when you want to add a visual annotation on their canvas work.',
  parameters: z.object({
    type: z.enum(['question', 'hint']).describe('Type of annotation: question for Socratic questions, hint for scaffolding/partial solutions'),
    text: z.string().describe('The annotation text. Keep concise (1-2 sentences max). Questions should be open-ended. Hints should be partial (not complete answers).'),
    positionHint: z.enum(['top-left', 'top-right', 'bottom-left', 'bottom-right', 'center']).optional().describe('Rough position preference. Algorithm will avoid overlaps.')
  }),
});

// In POST handler, add tools configuration:
const result = streamText({
  model: 'anthropic/claude-haiku-4.5',
  system: systemMessage,
  messages: modelMessages,
  tools: {
    proposeAnnotation: proposeAnnotationTool,
  },
  maxSteps: 5, // Allow tool calls
  temperature: 0.7,
});

// Tool calls are automatically included in streaming response
// Frontend will receive tool call results via useChat hook
```

**Update lib/ai/prompt.ts:**
Add guidance for when to propose annotations:

```typescript
export const SYSTEM_PROMPT = `**Role:** You are a Socratic math tutor. Your goal is to guide students to discover solutions themselves through thoughtful questions.

**Rules:**
1. NEVER provide direct answers or complete solutions
2. Ask ONE guiding question at a time in chat
3. Questions should help students notice what they've done, what's missing, or what to try next
4. If student is stuck, ask about fundamentals or break problem into smaller steps
5. If student makes an error, ask questions that lead them to notice it themselves
6. Encourage thinking: "What do you notice about...", "What happens if...", "Why might..."
7. Keep responses concise and conversational (1-3 sentences)
8. Celebrate progress: acknowledge good reasoning when you see it

**Canvas Annotations (NEW):**
- You can propose annotations that appear ON the canvas itself
- Use proposeAnnotation tool to suggest:
  - **question**: Socratic questions positioned near relevant canvas work (e.g., "What does this variable represent?")
  - **hint**: Scaffolding hints like partial equations, next step suggestions, or nudges (e.g., "Try applying the quadratic formula")
- Propose 0-2 annotations per response (don't overwhelm)
- Only propose when you can reference specific canvas work
- Annotations should be concise (1-2 sentences max)
- Balance chat responses with annotation proposals

**Context you'll receive:**
- Original problem (text or image description)
- Canvas screenshot (student's current work)
- Conversation history

**Your responses should:**
- Reference specific parts of their work when relevant
- Build on previous questions in the conversation
- Adjust difficulty based on student's progress
- Use natural, encouraging language
- Propose canvas annotations strategically (not every response)

Remember: Guide, don't solve. The student learns by thinking, not by being told.`;
```

**Notes:**
- AI SDK's tool calling returns structured JSON automatically
- Frontend receives tool calls in messages array via useChat hook
- Tool calls include `name: 'proposeAnnotation'` and `args: { type, text, positionHint }`
- Client will extract tool calls and render as annotation overlays (next plan)
- Zod schema validates AI's output structure
  </action>
  <verify>
    POST /api/chat returns streaming response
    When AI proposes annotation, response includes tool_calls in message
    Tool call structure matches ProposedAnnotation type (type, text, positionHint)
    AI only proposes annotations when referencing canvas work (check logs)
    Build passes with TypeScript types exported correctly
    curl test: POST with screenshot → response includes annotation proposals
  </verify>
  <done>AI generates structured annotation proposals via tool calling, types defined, system prompt updated with annotation guidance</done>
</task>

</tasks>

<verification>
**Collapsible chat:**
1. Chat sidebar toggles between ~320px and ~48px width
2. Canvas expands/contracts smoothly (flexbox layout works)
3. Collapsed state shows minimal UI (toggle button + "AI" indicator)
4. No content overflow or layout jank

**AI annotation proposals:**
1. AI chat API includes tool configuration for proposeAnnotation
2. Tool calls return structured JSON matching ProposedAnnotation type
3. System prompt guides AI to propose 0-2 annotations per response
4. Annotations only proposed when canvas work exists (not on initial greeting)

**Technical checks:**
- Build passes: `npm run build`
- TypeScript passes: `npx tsc --noEmit`
- No console errors during chat interaction
- Tool call validation works (Zod schema catches invalid proposals)

**Requirements coverage:**
- WORK-03: Collapsible chat sidebar ✓
- ANNO-01: AI proposes text question annotations ✓
- ANNO-02: AI proposes hint/scaffolding annotations ✓
</verification>

<success_criteria>
- [ ] User can collapse chat sidebar with smooth 300ms transition
- [ ] Canvas expands to fill available space when chat collapses
- [ ] Toggle button always visible and keyboard accessible
- [ ] AI generates annotation proposals via structured tool calling
- [ ] Annotation types include "question" and "hint"
- [ ] Proposals include text and optional position hint
- [ ] System prompt guides AI to propose 0-2 annotations strategically
- [ ] TypeScript types exported and used consistently
- [ ] Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-guidance-annotations/03-01-SUMMARY.md`
</output>
