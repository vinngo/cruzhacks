---
phase: 03-guidance-annotations
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - components/workspace/AnnotationOverlay.tsx
  - components/workspace/CanvasPanel.tsx
  - components/TldrawEditor.tsx
autonomous: false

must_haves:
  truths:
    - "User can approve annotation to add it permanently to canvas"
    - "Approved annotation renders as tldraw text shape on canvas"
    - "User can dismiss annotation to remove it without adding to canvas"
    - "Dismissed annotation leaves no trace (not in state or on canvas)"
    - "Complete demo flow works: problem → canvas work → AI guidance → annotation → solve"
  artifacts:
    - path: "components/workspace/AnnotationOverlay.tsx"
      provides: "Approve handler that adds shape to canvas"
      contains: "createShape.*text"
    - path: "components/TldrawEditor.tsx"
      provides: "addAnnotationToCanvas method exposed via ref"
      exports: ["TldrawEditorRef"]
      contains: "createShape"
    - path: "components/workspace/CanvasPanel.tsx"
      provides: "Wiring between overlay approve and tldraw shape creation"
      contains: "addAnnotationToCanvas"
  key_links:
    - from: "components/workspace/AnnotationOverlay.tsx"
      to: "components/TldrawEditor.tsx"
      via: "editorRef.addAnnotationToCanvas() on approve"
      pattern: "addAnnotationToCanvas"
    - from: "components/TldrawEditor.tsx"
      to: "tldraw createShape API"
      via: "editor.createShape with text type"
      pattern: "createShape.*type.*text"
---

<objective>
Wire annotation approve action to add text shapes to canvas via tldraw API, and verify complete demo flow.

Purpose: Complete the annotation system by implementing the approve action that adds annotations as permanent canvas shapes, and verify the full user journey from problem submission to AI-guided problem solving. Achieves Phase 3's goal: interactive canvas annotations that guide learning.

Output: Working approve/dismiss handlers, tldraw integration for adding text shapes, verified end-to-end demo flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-guidance-annotations/03-01-SUMMARY.md
@.planning/phases/03-guidance-annotations/03-02-SUMMARY.md

# Files to modify
@components/workspace/AnnotationOverlay.tsx
@components/TldrawEditor.tsx
@components/workspace/CanvasPanel.tsx
@lib/annotation-positioning.ts
</context>

<tasks>

<task type="auto">
  <name>Implement approve handler with tldraw shape creation</name>
  <files>components/TldrawEditor.tsx, components/workspace/AnnotationOverlay.tsx, components/workspace/CanvasPanel.tsx</files>
  <action>
**Update TldrawEditor.tsx:**
Add method to create text shapes from annotations:

```typescript
import { createShapeId } from 'tldraw';

export interface TldrawEditorRef {
  captureScreenshot: () => Promise<string[] | null>;
  addAnnotationToCanvas: (text: string, position: { x: number; y: number }, color: string) => void;
}

// In useImperativeHandle:
useImperativeHandle(ref, () => ({
  captureScreenshot: async () => { /* existing */ },
  addAnnotationToCanvas: (text: string, position: { x: number; y: number }, color: string) => {
    if (!editorRef.current) {
      console.warn('Editor not mounted yet');
      return;
    }

    const shapeId = createShapeId();

    editorRef.current.createShape({
      id: shapeId,
      type: 'text',
      x: position.x,
      y: position.y,
      props: {
        text,
        color, // 'blue' for questions, 'yellow' for hints (tldraw colors)
        size: 'm',
        font: 'sans',
        textAlign: 'start',
        w: 250, // Width of text box
      },
    });

    // Optional: Select the new shape to draw attention
    editorRef.current.select(shapeId);
  },
}));
```

**Update AnnotationOverlay.tsx:**
Wire approve button to tldraw shape creation:

```typescript
import { calculateAnnotationPosition } from '@/lib/annotation-positioning';

interface AnnotationOverlayProps {
  editorRef: React.RefObject<TldrawEditorRef>;
}

export function AnnotationOverlay({ editorRef }: AnnotationOverlayProps) {
  const { proposedAnnotations, removeProposedAnnotation } = useProblem();

  const handleApprove = (annotation: ProposedAnnotation) => {
    if (!editorRef.current) {
      console.warn('Editor ref not available');
      return;
    }

    // Calculate position using smart positioning algorithm
    const position = calculateAnnotationPosition(
      editorRef.current.getEditor(), // Expose editor from ref if needed
      annotation,
    );

    // Convert annotation type to tldraw color
    const color = annotation.type === 'question' ? 'blue' : 'yellow';

    // Add to canvas as text shape
    editorRef.current.addAnnotationToCanvas(annotation.text, position, color);

    // Remove from proposed annotations
    removeProposedAnnotation(annotation.id);
  };

  const handleDismiss = (id: string) => {
    // Simply remove from state - no trace left
    removeProposedAnnotation(id);
  };

  // ... rest of component
}
```

**Update CanvasPanel.tsx (if needed):**
Ensure editorRef is passed correctly to AnnotationOverlay:

```typescript
const editorRef = useRef<TldrawEditorRef>(null);

return (
  <div className="relative w-full h-full">
    <TldrawEditor ref={editorRef} onChange={handleCanvasChange} />
    <AnnotationOverlay editorRef={editorRef} />
  </div>
);
```

**Implementation notes:**
- tldraw text shape props: https://tldraw.dev/docs/shapes#text-shape
- Color options: 'black', 'grey', 'light-violet', 'violet', 'blue', 'light-blue', 'yellow', 'orange', 'green', 'light-green', 'light-red', 'red'
- Use 'blue' for questions (Socratic), 'yellow' for hints (caution/attention)
- Text box width (w: 250) allows wrapping for longer annotations
- Position (x, y) is canvas coordinates (not screen pixels)
- createShapeId() generates unique ID for shape

**Coordinate conversion (if needed):**
If calculateAnnotationPosition returns screen pixels but tldraw expects canvas coordinates:
- Use editor.screenToPage({ x, y }) to convert
- Or: calculateAnnotationPosition should already return page coordinates

**Fallback if editor access issues:**
If editorRef.current.getEditor() not available, modify TldrawEditorRef to expose editor instance:

```typescript
export interface TldrawEditorRef {
  // ...
  getEditor: () => Editor | null;
}

// In useImperativeHandle:
getEditor: () => editorRef.current,
```
  </action>
  <verify>
    AI proposes annotation → AnnotationCard appears
    Click "Approve" → text shape appears on canvas
    Text shape contains annotation text
    Question annotations appear in blue
    Hint annotations appear in yellow
    Approved annotation disappears from overlay
    Click "Dismiss" → annotation disappears, no shape added
    Dismissed annotation leaves no trace (not in state, not on canvas)
    Multiple approve/dismiss actions work correctly
    Build passes: npm run build
  </verify>
  <done>Approve adds annotation as tldraw text shape, dismiss removes cleanly, both update proposedAnnotations state correctly</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete AI-guided annotation system:
- Collapsible chat sidebar (Phase 3 Plan 1)
- AI structured annotation proposals via tool calling (Phase 3 Plan 1)
- Annotation overlay UI with approve/dismiss buttons (Phase 3 Plan 2)
- Smart positioning avoiding canvas shapes (Phase 3 Plan 2)
- Approve handler adding annotations to canvas as tldraw shapes (Phase 3 Plan 3)
- Dismiss handler removing annotations without trace (Phase 3 Plan 3)
  </what-built>
  <how-to-verify>
**Complete demo flow (Success Criteria 7 from Phase 3):**

1. **Start fresh:**
   - Open http://localhost:3000
   - Clear localStorage: `localStorage.clear()` in console
   - Refresh page

2. **Submit problem:**
   - Enter math problem (text or upload image): "Solve for x: 2x + 5 = 15"
   - Click submit → transition to workspace
   - Verify: Problem displays in left panel
   - Verify: AI sends initial greeting in chat

3. **Work on canvas:**
   - Draw or write on canvas (start solving the problem)
   - Example: Write "2x + 5 = 15" on canvas
   - Pause for 4 seconds
   - Verify: Chat shows "Analyzing canvas..."
   - Verify: AI responds with Socratic question OR proposes annotation

4. **Interact with annotations:**
   - If AI proposes annotation:
     - Verify: Annotation card appears overlaid on canvas
     - Verify: Question type → blue theme, Hint type → amber theme
     - Verify: Card includes approve/dismiss buttons
     - Click "Approve" → annotation added to canvas as text shape
     - Verify: Annotation text appears on canvas (blue for question, yellow for hint)
     - Verify: Approved annotation removed from overlay
   - If AI proposes another annotation:
     - Click "Dismiss" → annotation disappears
     - Verify: No shape added to canvas
     - Verify: Dismissed annotation not in overlay or state

5. **Test collapsible chat:**
   - Click chevron button in chat header
   - Verify: Chat collapses to ~48px width with smooth animation
   - Verify: Canvas expands to fill space
   - Click chevron again
   - Verify: Chat expands back to ~320px

6. **Continue solving:**
   - Add more work to canvas
   - Continue conversation with AI
   - Verify: AI references both canvas work and chat history
   - Verify: Multiple annotations can exist simultaneously
   - Verify: Annotations positioned to avoid overlapping canvas work

7. **Final verification:**
   - All Phase 3 requirements met (see checklist below)
   - No console errors
   - Smooth transitions and interactions
   - Professional appearance and UX

**Phase 3 Requirements Checklist:**

- [ ] AI-05: User receives AI's Socratic questions in chat sidebar ✓
- [ ] WORK-03: Collapsible chat sidebar ✓
- [ ] ANNO-01: AI proposes text question annotations ✓
- [ ] ANNO-02: AI proposes hint/scaffolding annotations ✓
- [ ] ANNO-03: Annotations have approve/dismiss buttons ✓
- [ ] ANNO-04: Annotations positioned to avoid overlaps ✓
- [ ] ANNO-05: Approve adds annotation to canvas via tldraw ✓
- [ ] ANNO-06: Dismiss removes annotation without trace ✓

**Common issues to check:**

- Annotations not appearing: Check console for tool call extraction errors
- Annotations overlap canvas work: Verify positioning algorithm using shape bounds
- Approve doesn't add to canvas: Check editorRef and createShape call
- Chat not collapsing smoothly: Verify transition-all CSS class
- AI not proposing annotations: Check system prompt guidance in route.ts

**If any issues found:**
Document them clearly:
- What action was taken
- What happened (actual result)
- What should happen (expected result)
- Console errors (if any)
- Screenshots (if visual issue)
  </how-to-verify>
  <resume-signal>
Type "approved" if demo flow works end-to-end, or describe specific issues to address.
  </resume-signal>
</task>

</tasks>

<verification>
**Approve handler:**
1. Clicking approve creates tldraw text shape on canvas
2. Text shape contains annotation text
3. Question annotations render in blue
4. Hint annotations render in yellow
5. Approved annotation removed from overlay

**Dismiss handler:**
1. Clicking dismiss removes annotation from overlay
2. No shape added to canvas
3. No trace in proposedAnnotations state

**End-to-end demo flow:**
1. User submits problem → workspace loads
2. User works on canvas → AI analyzes and responds
3. AI proposes annotations via tool calling
4. Annotations appear as overlays with approve/dismiss
5. User approves → annotation added to canvas
6. User dismisses → annotation removed cleanly
7. User continues solving with AI guidance

**Technical checks:**
- Build passes: `npm run build`
- No console errors during full flow
- tldraw createShape API called correctly
- Coordinate system correct (canvas vs screen pixels)
- State management clean (no memory leaks)

**Requirements coverage:**
- AI-05: Socratic questions in chat ✓
- WORK-03: Collapsible chat sidebar ✓
- ANNO-01: Text question annotations ✓
- ANNO-02: Hint/scaffolding annotations ✓
- ANNO-03: Approve/dismiss buttons ✓
- ANNO-04: Smart positioning ✓
- ANNO-05: Approve adds to canvas ✓
- ANNO-06: Dismiss removes without trace ✓
</verification>

<success_criteria>
- [ ] Approve button adds annotation as tldraw text shape on canvas
- [ ] Question annotations render in blue on canvas
- [ ] Hint annotations render in yellow on canvas
- [ ] Approved annotations removed from overlay
- [ ] Dismiss button removes annotation without adding to canvas
- [ ] Dismissed annotations leave no trace in state
- [ ] Complete demo flow verified by user
- [ ] All Phase 3 requirements met
- [ ] Build passes without errors
- [ ] User approves checkpoint (no blocking issues)
</success_criteria>

<output>
After completion, create `.planning/phases/03-guidance-annotations/03-03-SUMMARY.md`
</output>
